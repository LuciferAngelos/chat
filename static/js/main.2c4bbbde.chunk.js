(this["webpackJsonpvoice-chat"]=this["webpackJsonpvoice-chat"]||[]).push([[0],{116:function(e,t,n){},119:function(e,t,n){"use strict";n.r(t);var c=n(0),a=n.n(c),r=n(16),o=n.n(r),i=(n(84),n(72)),s=n(8),u=(n(85),n(156)),l=n(59),d=n.n(l),j=n(60),b=n(150),f=n(152),O=n(153),h=n(27),x=n(155),p=n(154),v=n(64),m=n.n(v),g=n(10),S=Object(c.createContext)(),y=n(13),w="INITIALIZED_SUCCESS",k="TOKEN_USER_UUID_GOTTEN",U="ON_LINK_GOTTEN",F="ON_DIALOG",E="GET_OUTPUT_PLAYER_VOICE_FROM_CLIENT",_="GET_OUTPUT_PLAYER_VOICE_FROM_SERVER",N={initialized:!1,linkIsFetched:!1,sessionToken:"",userUUID:"",linkForSS:"",onDialog:!1,outputPlayerVoiceFromClient:null,outputPlayerVoiceFromSS:null},T=function(e,t){return{type:k,payload:{sessionToken:e,userUUID:t}}},C=function(e){return{type:U,link:e}},I=n(2),A=Object(b.a)((function(e){return{root:{flexGrow:1},menuButton:{marginRight:e.spacing(2)},title:{flexGrow:1}}}));var L=function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],c=!0===n?0:36,a="";!1===n&&(e.offset=t,a=e.readUtf8String(c)),e.offset=t+c+0;var r=e.readUInt32LE(),o={x:0,y:0,z:0};e.offset=t+c+4+0,o.x=e.readFloatLE(),e.offset=t+c+4+4,o.y=e.readFloatLE(),e.offset=t+c+4+8,o.z=e.readFloatLE(),e.offset=t+c+4+12;var i=e.readUInt8();return{uuid:a,id:r,position:o,state:i}};function D(){var e=A(),t=Object(c.useState)(!1),n=Object(s.a)(t,2),a=n[0],r=n[1],o=(Object(g.b)(),Object(c.useContext)(S)),i=o.linkForSS;o.sessionTokenForSS,o.userUUIDForSS,Object(g.c)((function(e){return e.app.onDialog})),Object(g.c)((function(e){return e.app.outputPlayerVoiceFromClient}));return Object(c.useEffect)((function(){!function e(){var t=i?new WebSocket(i):console.log("Fetching the link...");t.binaryType="arraybuffer",t.onopen=function(){d.a.get("https://getway.dev.viexpo.ru/api/account/fake/get").then((function(e){var n=e.data.response.session_uuid,c=new Uint8Array(77),a=new Uint8Array(new Uint32Array([0]).buffer),o=(new TextEncoder).encode(n),i=(new TextEncoder).encode("123456789012345678901234567890123456");c.set(a,0),c.set(o,4),c.set(new Uint8Array([0]),40),c.set(i,41),t.send(c),1===t.readyState&&r(!0)}))},t.onmessage=function(e){var n=new j.BufferStream(e.data);n.offset=0;var c=n.readInt32LE();switch(c){case 9994:n.offset=4;for(var a=n.readUInt32LE(),r=[],o=0;o<a;o++){var i=L(n,8+53*o);r.push(i)}console.log(JSON.stringify(r)),console.log("Method: FromMovement_FromPlayerScene_PlayerList, count: "+a,r),console.log("Sound Server WebSocket state is "+t.readyState);break;case 9992:var s=L(n,4);console.log("User Join: "+s.uuid);break;case 9993:n.offset=4;var u=n.readUtf8String(36);console.log("User Leave: "+u);break;case 9996:var l=L(n,4,!0);!function(e){var t=new Blob([e],{type:"audio/webm;codecs=opus"}),n=new FileReader;n.readAsDataURL(t),n.onloadend=function(){var e=n.result,t=new Audio(e);t.addEventListener("canplaythrough",(function(){t.play()}))}}(new Uint8Array(n.buffer.buffer,21)),console.log("FromSound_FromPlayerScene_PlayerVoice => ",l);break;default:console.log("Method: Unknown")}console.log("WebSocket message received:",c)},t.onclose=function(n){console.log("Sound Server Socket closed. Trying to reconnect..."),console.log("Server closed with code => ",n.code),1!==t.readyState&&r(!1),setTimeout((function(){e(),console.log(t.readyState)}),1e3)},t.onerror=function(e){console.log("This error happened => ",e),t.close()};window.sendPlayerTick=function(e){return function(e,n,c){console.log("the voice body is ",e,n,c);var a=new Uint8Array(17+c.byteLength),r=new Uint8Array(new Uint32Array([9991]).buffer);a.set(r,0),a.set(new Uint8Array(new Float32Array([e.x]).buffer),4),a.set(new Uint8Array(new Float32Array([e.y]).buffer),8),a.set(new Uint8Array(new Float32Array([e.z]).buffer),12),a.set(new Uint8Array([n]),16),a.set(c,17),1===t.readyState&&t.send(a)}({x:0,y:0,z:0},0,e)}}()}),[i]),Object(I.jsx)("div",{className:e.root,children:Object(I.jsx)(f.a,{position:"static",children:Object(I.jsxs)(O.a,{children:[Object(I.jsx)(p.a,{edge:"start",className:e.menuButton,color:"inherit","aria-label":"menu",children:Object(I.jsx)(m.a,{})}),Object(I.jsxs)(h.a,{variant:"h6",className:e.title,children:["Connection Status:",a?" Connected!":" Disconnected!"]}),Object(I.jsx)(x.a,{color:"inherit",children:"AChat Connection"})]})})})}var P=n(65),R=n(40),M=n.n(R),B=n(43),V=n.n(B),W=n(29),z=n.n(W),G=n(66),J=n.n(G),K=n(160),X=n(159),Y=n(158),q=n(32),Z=(n(116),n(157)),H=(n(58),Object(b.a)((function(e){return{icon:{height:38,width:38},reactmic:{width:"50%",height:30},wavesurfer:{width:"50%",margin:"0 auto"},flex:{flex:1}}})));function Q(e){e.pushFile,e.setCurrentAvatarId,Object(g.b)();var t=Object(c.useState)(!1),n=Object(s.a)(t,2),a=n[0],r=n[1],o=Object(c.useState)(!1),i=Object(s.a)(o,2),l=(i[0],i[1],Object(c.useState)(!0)),d=Object(s.a)(l,2),j=d[0],b=d[1],f=Object(c.useState)(!1),O=Object(s.a)(f,2),h=(O[0],O[1],Object(c.useState)(!1)),x=Object(s.a)(h,2);x[0],x[1],Object(c.useRef)(null);Object(c.useEffect)((function(){j||navigator.mediaDevices.getUserMedia({audio:!0}).then((function(e){var t=new window.MediaRecorder(e),n=[];console.log(e.getAudioTracks()),t.start(),window.str=e,t.addEventListener("dataavailable",(function(e){n.push(e.data)})),t.addEventListener("stop",(function(){if(n.length>0){var e=n[0].type;new Blob(n,{type:e}).arrayBuffer().then((function(e){var t=new Uint8Array(e);window.sendPlayerTick(t)}))}n=[],null!==window.str&&(t.start(),setTimeout((function(){"inactive"!==t.state&&t.stop()}),1e3))})),setTimeout((function(){"inactive"!==t.state&&t.stop()}),1e3)}))}),[a,j]);var v=function(){r(!0),b(!1)};var m=function(){r(!1),b(!0),window.str.getAudioTracks().forEach((function(e){e.stop()})),window.str=null},S=H();return Object(I.jsxs)(I.Fragment,{children:[Object(I.jsx)(u.a,{container:!0,justify:"center",children:Object(I.jsx)(u.a,{item:!0,children:!a&&j?Object(I.jsx)(p.a,{onClick:v,children:Object(I.jsx)(V.a,{className:S.icon})}):Object(I.jsx)(p.a,{onClick:m,children:Object(I.jsx)(V.a,{className:S.icon})})})}),Object(I.jsxs)(Z.a,{children:[Object(I.jsx)(Y.a,{className:S.flex,children:"Open Micro"}),Object(I.jsxs)(X.a,{children:[Object(I.jsx)("div",{}),Object(I.jsx)(P.ReactMic,{record:a,className:S.reactmic,visualSetting:"frequencyBars",echoCancellation:!0,noiseSuppression:!0,onStop:function(){},onData:function(e){},strokeColor:"green",backgroundColor:"white"})]}),Object(I.jsx)(K.a,{children:Object(I.jsx)(u.a,{container:!0,children:Object(I.jsxs)(u.a,{item:!0,container:!0,justify:"center",xs:12,children:[!a&&j&&Object(I.jsx)(p.a,{onClick:v,children:Object(I.jsx)(J.a,{style:{color:q.a[500]},className:S.icon})}),a&&!j&&Object(I.jsx)(p.a,{onClick:m,children:Object(I.jsx)(z.a,{className:S.icon})})]})})})]})]})}var $=n(67),ee=n.n($),te=n(166),ne=n(41),ce=n.n(ne),ae=n(70),re=n.n(ae),oe=n(69),ie=n.n(oe),se=n(68),ue=n.n(se),le=n(164),de=n(165),je=n(42),be=n.n(je),fe=n(161),Oe=n(167),he=n(163),xe=n(162),pe=Object(b.a)((function(e){return{card:{maxWidth:600,minWidth:240,margin:"20px auto 0",transition:"0.3s",boxShadow:"0 8px 40px -12px rgba(0,0,0,0.3)","&:hover":{boxShadow:"0 16px 70px -12.125px rgba(0,0,0,0.3)"}},media:{width:"100%"},list:{padding:0},listItem:{},buttons:{padding:e.spacing(1)},controls:{minWidth:"100px"},icon:{height:18,width:18},avatar:{display:"inline-block"}}}));var ve=function(e){var t=e.file,n=e.currentAvatarId,a=Object(c.useRef)(null),r=Object(c.useState)(!1),o=Object(s.a)(r,2),i=(o[0],o[1]),l=Object(c.useState)(!1),d=Object(s.a)(l,2),j=d[0],b=d[1],f="wavesurfer--".concat(ee()());Object(c.useEffect)((function(){if(t){a.current=M.a.create({container:"#".concat(f),waveColor:"grey",progressColor:"tomato",height:70,cursorWidth:1,cursorColor:"lightgray",barWidth:2,normalize:!0,responsive:!0,fillParent:!0});var e=t;a.current.load(e),a.current.on("ready",(function(){i(!0)}));var n=a.current.util.debounce((function(){a.current.empty(),a.current.drawBuffer()}),150);a.current.on("play",(function(){return b(!0)})),a.current.on("pause",(function(){return b(!1)})),window.addEventListener("resize",n,!1)}}),[t]),Object(c.useEffect)((function(){console.log("file",t),t&&a.current.load(t.blobURL)}),[t]);var O,h=function(){j?a.current.pause():a.current.play()},x=pe();return O=j?Object(I.jsx)(p.a,{onClick:h,children:Object(I.jsx)(be.a,{className:x.icon})}):Object(I.jsx)(p.a,{onClick:h,children:Object(I.jsx)(ce.a,{className:x.icon})}),Object(I.jsx)(I.Fragment,{children:t&&Object(I.jsx)(Z.a,{className:x.card,children:Object(I.jsxs)(u.a,{container:!0,direction:"column",children:[Object(I.jsx)(u.a,{item:!0,children:Object(I.jsx)(fe.a,{className:x.list,children:Object(I.jsxs)(Oe.a,{alignItems:"flex-start",className:x.listItem,children:[Object(I.jsx)(xe.a,{children:Object(I.jsx)(te.a,{className:x.avatar,src:"http://i.pravatar.cc/300?img=".concat(n)})}),Object(I.jsx)(he.a,{primary:"Username",secondary:"@username \xb7 2h ago"})]})})}),Object(I.jsx)(u.a,{item:!0,id:f}),Object(I.jsxs)(u.a,{item:!0,container:!0,className:x.buttons,children:[Object(I.jsxs)(u.a,{item:!0,xs:5,children:[O,Object(I.jsx)(p.a,{onClick:function(){return a.current.stop()},children:Object(I.jsx)(z.a,{className:x.icon})})]}),Object(I.jsxs)(u.a,{item:!0,xs:7,container:!0,justify:"space-around",children:[Object(I.jsx)(u.a,{item:!0,children:Object(I.jsx)(p.a,{children:Object(I.jsx)(ue.a,{style:{color:le.a[500]},className:x.icon})})}),Object(I.jsx)(u.a,{item:!0,children:Object(I.jsx)(p.a,{children:Object(I.jsx)(ie.a,{style:{color:q.a[500]},className:x.icon})})}),Object(I.jsx)(u.a,{item:!0,children:Object(I.jsx)(p.a,{children:Object(I.jsx)(re.a,{style:{color:de.a[500]},className:x.icon})})})]})]})]})})})},me=n(26),ge=n(71),Se=Object(me.b)({app:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:N,t=arguments.length>1?arguments[1]:void 0;switch(t.type){case w:return Object(y.a)(Object(y.a)({},e),{},{initialized:!0});case k:return Object(y.a)(Object(y.a)({},e),t.payload);case F:return Object(y.a)(Object(y.a)({},e),{},{onDialog:!e.onDialog});case E:return Object(y.a)(Object(y.a)({},e),{},{outputPlayerVoiceFromClient:t.voice});case _:return Object(y.a)(Object(y.a)({},e),{},{outputPlayerVoiceFromSS:t.voice});case U:return Object(y.a)(Object(y.a)({},e),{},{linkIsFetched:!0,linkForSS:t.link});default:return e}}}),ye=window.__REDUX_DEVTOOLS_EXTENSION_COMPOSE__||me.c,we=Object(me.d)(Se,ye(Object(me.a)(ge.a)));window.__store__=we;var ke=we;n.p;var Ue=function(){return Object(I.jsxs)("div",{className:"lds-facebook",children:[Object(I.jsx)("div",{}),Object(I.jsx)("div",{}),Object(I.jsx)("div",{})]})};var Fe=function(){var e=Object(g.b)(),t=Object(c.useState)(!1),n=Object(s.a)(t,2),a=n[0],r=n[1],o=Object(c.useState)({linkForSS:"",sessionTokenForSS:"",userUUIDForSS:""}),l=Object(s.a)(o,2),d=l[0],j=l[1],b=Object(g.c)((function(e){return e.app.linkIsFetched})),f=Object(g.c)((function(e){return e.app.linkForSS})),O=Object(g.c)((function(e){return e.app.sessionToken})),h=Object(g.c)((function(e){return e.app.userUUID}));Object(c.useMemo)((function(){e(C),e(T),j({linkForSS:f,sessionTokenForSS:O,userUUIDForSS:h})}),[f,O,h]),Object(c.useCallback)((function(){}),[]),Object(c.useEffect)((function(){!function(e){var t=new WebSocket(e);!function e(){t.onopen=function(){console.log("GetWay Socket connected"),t.send(JSON.stringify({method:0,token:"0e1e703b-059b-4d3d-b275-3fc36ea4e8c4",type:1}))},t.onmessage=function(e){var n=JSON.parse(e.data);if(console.log(n),void 0!=n.method)switch(n.method){case 1:console.log(n.user.session_uuid,n.user.user_uuid),ke.dispatch(T(n.user.session_uuid,n.user.user_uuid)),t.send(JSON.stringify({method:7,company_uuid:"1"}));break;case 8:var c="wss://".concat(n.ip,":").concat(n.port);ke.dispatch(C(c));break;default:console.log("Unexpected method")}},t.onclose=function(){console.log("Sound Server Socket closed. trying to reconnect..."),setTimeout((function(){e()}),1e3)}}()}("wss://getway.dev.viexpo.ru:8010")}),[]),Object(c.useMemo)((function(){r(b)}),[b]),Object(c.useEffect)((function(){}),[]);var x=Object(c.useState)([]),p=Object(s.a)(x,2),v=p[0],m=p[1],y=Object(c.useState)(0),w=Object(s.a)(y,2),k=w[0],U=w[1];return Object(I.jsx)(S.Provider,{value:d,children:Object(I.jsx)("div",{className:"home",style:{textAlign:"center"},children:a?Object(I.jsxs)("div",{children:[Object(I.jsx)(D,{}),Object(I.jsx)(Q,{pushFile:function(e){m([].concat(Object(i.a)(v),[e]))},setCurrentAvatarId:U}),Object(I.jsx)(u.a,{container:!0,direction:"column",spacing:3,children:v.map((function(e,t){return Object(I.jsx)(u.a,{item:!0,children:Object(I.jsx)(ve,{file:e,currentAvatarId:k})},t)}))})]}):Object(I.jsx)(Ue,{})})})},Ee=function(e){e&&e instanceof Function&&n.e(3).then(n.bind(null,169)).then((function(t){var n=t.getCLS,c=t.getFID,a=t.getFCP,r=t.getLCP,o=t.getTTFB;n(e),c(e),a(e),r(e),o(e)}))};o.a.render(Object(I.jsx)(a.a.StrictMode,{children:Object(I.jsx)(g.a,{store:ke,children:Object(I.jsx)(Fe,{})})}),document.getElementById("root")),Ee()},58:function(e,t){},84:function(e,t,n){},85:function(e,t,n){}},[[119,1,2]]]);
//# sourceMappingURL=main.2c4bbbde.chunk.js.map